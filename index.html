<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>座標強化版-記憶規劃表</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
<script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>

<style>
    :root {
        --primary-color: #4a90e2;
        --bg-color: #f4f6f8;
        --border-color: #ddd;
        --slot-height: 80px; /* 進一步加大格子，增加觸控容錯率 */
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0; padding: 0; height: 100vh;
        display: flex; flex-direction: column;
        background-color: var(--bg-color);
        overflow: hidden; 
        touch-action: none; 
    }

    /* 頂部控制列優化 */
    #project-bar, #settings-bar {
        background: #fff; padding: 10px;
        display: flex; gap: 8px; overflow-x: auto;
        border-bottom: 1px solid var(--border-color);
        z-index: 100;
    }

    #main-container { display: flex; flex: 1; overflow: hidden; flex-direction: column; }

    /* 事項池：改為大方塊，方便抓取 */
    #sidebar {
        height: 140px; background: #eee;
        display: flex; flex-direction: column; padding: 10px;
    }
    #task-pool { 
        flex: 1; display: flex; gap: 15px; 
        overflow-x: auto; padding: 10px 5px;
        align-items: center;
    }

    #calendar-area { 
        flex: 1; overflow: auto; background: white; 
        touch-action: pan-x pan-y;
        -webkit-overflow-scrolling: touch;
    }
    #calendar-grid { display: grid; border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color); }

    .task-card {
        min-width: 100px; height: 50px; border-radius: 8px;
        color: #000; font-size: 14px; cursor: grab;
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        user-select: none; position: relative;
        display: flex; align-items: center; font-weight: bold;
        touch-action: none; 
        background: white; border: 1px solid rgba(0,0,0,0.1);
    }
    
    .task-text { padding: 0 10px; flex: 1; pointer-events: none; } /* 防止文字干擾拖放 */

    /* 格子感應強化 */
    .grid-cell { 
        height: var(--slot-height); 
        border-right: 1px solid var(--border-color); 
        border-bottom: 1px solid var(--border-color);
        position: relative;
        box-sizing: border-box;
    }
    
    /* 增加一個隱形的感應擴張層 */
    .grid-cell::after {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        z-index: 1;
    }

    .grid-cell.drag-over { 
        background-color: #e3f2fd !important; 
        box-shadow: inset 0 0 10px var(--primary-color);
    }

    .grid-header-day { background: #333; color: white; padding: 10px; position: sticky; top: 0; z-index: 10; text-align: center; }
    .time-label { background: #f0f0f0; width: 50px; font-size: 12px; position: sticky; left: 0; z-index: 9; display: flex; align-items: center; justify-content: center; border-right: 2px solid #ccc; }
</style>
</head>
<body>

<div id="project-bar">
    <select id="project-selector" onchange="switchProject()"></select>
    <button onclick="saveProject()">儲存</button>
</div>

<div id="main-container">
    <div id="sidebar">
        <div style="display:flex; gap:5px;">
            <input type="text" id="new-task-name" placeholder="新事項">
            <button onclick="addNewTaskManual()">新增</button>
        </div>
        <div id="task-pool"></div>
    </div>
    <div id="calendar-area">
        <div id="calendar-grid"></div>
    </div>
</div>

<script>
    // 關鍵設定：強制設定拖曳時的座標偏移修正
    MobileDragDrop.polyfill({
        holdToDrag: 300, // 長按 300 毫秒才觸發拖放，避免跟捲動衝突
        dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
    });

    let draggedItem = null;

    // 核心修正：手動判定位置
    function onDrop(e) {
        e.preventDefault();
        const cell = e.currentTarget;
        cell.classList.remove('drag-over');
        
        if (!draggedItem) return;

        // 如果是從池子拉出來的，就複製一個；如果是格子間移動，就移動本體
        let finalItem;
        if (draggedItem.parentElement.id === 'task-pool') {
            finalItem = createTaskElement(
                draggedItem.querySelector('.task-text').innerText, 
                draggedItem.style.backgroundColor
            );
        } else {
            finalItem = draggedItem;
        }
        
        cell.innerHTML = '';
        cell.appendChild(finalItem);
    }

    function createTaskElement(name, color) {
        const div = document.createElement('div');
        div.className = 'task-card';
        div.draggable = true;
        div.style.backgroundColor = color;
        
        const text = document.createElement('span');
        text.className = 'task-text'; 
        text.innerText = name;
        div.appendChild(text);

        div.addEventListener('dragstart', (e) => {
            draggedItem = div;
            div.style.opacity = '0.4';
            if (navigator.vibrate) navigator.vibrate(50); // 震動回饋
        });

        div.addEventListener('dragend', () => {
            div.style.opacity = '1';
        });

        // 點擊兩下刪除（手機上比 X 按鈕好點）
        div.addEventListener('dblclick', () => div.remove());

        return div;
    }

    function generateGrid() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `50px repeat(2, 1fr)`; // 手機建議一次看2欄就好

        // 簡易標頭與內容
        for(let i=0; i<3; i++) grid.appendChild(document.createElement('div')); // filler
        
        for (let h = 6; h <= 22; h++) {
            const label = document.createElement('div');
            label.className = 'time-label'; label.innerText = `${h}:00`;
            grid.appendChild(label);

            for (let d = 0; d < 2; d++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    cell.classList.add('drag-over');
                });
                cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                cell.addEventListener('drop', onDrop);
                
                grid.appendChild(cell);
            }
        }
    }

    function addNewTaskManual() {
        const input = document.getElementById('new-task-name');
        if (!input.value) return;
        document.getElementById('task-pool').appendChild(createTaskElement(input.value, '#FFB3BA'));
        input.value = '';
    }

    window.onload = generateGrid;
</script>
</body>
</html>
