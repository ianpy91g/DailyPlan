<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>智慧規劃表</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
<script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
    --primary-color:#4a90e2;
    --save-color:#2ecc71;
    --delete-color:#e74c3c;
    --bg-color:#f4f6f8;
    --border-color:#ddd;
    --slot-height:50px;
}
body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    margin:0;padding:0;height:100vh;
    display:flex;flex-direction:column;
    background-color:var(--bg-color);overflow:hidden;
}
#project-bar{
    background:#333;color:#fff;padding:8px 12px;
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;z-index:100;
}
#project-bar input,#project-bar select{padding:5px;border-radius:4px;border:none}
button.btn{
    border:none;padding:6px 12px;border-radius:4px;
    cursor:pointer;color:#fff;font-weight:bold;
}
.btn-blue{background-color:var(--primary-color)}
.btn-green{background-color:var(--save-color)}
.btn-red{background-color:var(--delete-color)}
.btn-orange{background-color:#f39c12}

#settings-bar{
    background:#fff;padding:10px;
    display:flex;gap:8px;flex-wrap:wrap;
    align-items:center;font-size:13px;
    border-bottom:1px solid var(--border-color);
}
.setting-group{display:flex;align-items:center;gap:4px}
input[type="number"],input[type="date"],select{
    padding:4px;border:1px solid #ccc;border-radius:4px
}
input[type="number"]{width:60px}

#main-container{display:flex;flex:1;overflow:hidden}
#sidebar{
    width:250px;background:#fff;border-right:1px solid var(--border-color);
    display:flex;flex-direction:column;padding:10px;
}
#task-pool{
    flex:1;overflow-y:auto;display:flex;
    flex-direction:column;gap:8px;
    padding:8px;border:1px solid #eee;
    border-radius:4px;background:#fafafa;
}
#calendar-area{flex:1;overflow:auto;padding:10px;background:#fff}
#calendar-grid{
    display:grid;
    border-top:1px solid var(--border-color);
    border-left:1px solid var(--border-color);
    margin-top:10px;
    transform-origin:top left;
}

.task-card{
    width:100%;height:100%;
    border-radius:3px;
    font-size:12px;cursor:grab;
    display:flex;align-items:center;
    user-select:none;touch-action:none;
    box-sizing:border-box;
}
.task-text{
    padding:4px;flex:1;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.grid-header-day,.grid-header-sub,.time-label,.grid-cell{
    border-right:1px solid var(--border-color);
    border-bottom:1px solid var(--border-color);
}
.grid-header-day{
    background:#eee;font-weight:bold;text-align:center;
    padding:8px 5px;position:sticky;top:0;z-index:10;
}
.grid-header-sub{
    background:#f9f9f9;font-size:10px;
    text-align:center;color:#999;
    position:sticky;top:46px;z-index:9;
}
.time-label{
    background:#f9f9f9;font-size:11px;
    text-align:right;padding-right:8px;
    position:sticky;left:0;z-index:8;
    height:var(--slot-height);
    display:flex;align-items:flex-start;justify-content:flex-end;
}
.time-text{transform:translateY(-50%);background:#f9f9f9;padding:0 2px}
.grid-cell{height:var(--slot-height);background:#fff}
.grid-cell.drag-over{background:#e3f2fd}
</style>
</head>

<body>
<div id="project-bar">
    <span>專案:</span>
    <select id="project-selector" onchange="switchProject()"></select>
    <input type="text" id="new-project-name" placeholder="新名稱">
    <button class="btn btn-green" onclick="saveProject()">儲存專案</button>
    <button class="btn btn-orange" onclick="exportData()">導出 JSON</button>
    <button class="btn btn-orange" onclick="importData()">導入 JSON</button>
    <button class="btn btn-orange" onclick="exportScheduleImage()">匯出圖片</button>
    <button class="btn btn-blue" onclick="fitScheduleToView()">符合版面</button>
    <button class="btn btn-red" onclick="deleteProject()">刪除</button>
    <input type="file" id="import-file" style="display:none" onchange="handleFileImport(event)">
</div>

<div id="settings-bar">
    <div class="setting-group"><label>起始:</label><input type="date" id="start-date"></div>
    <div class="setting-group">
        <label>時段:</label>
        <select id="start-time"></select> -
        <select id="end-time"></select>
    </div>
    <div class="setting-group">
        <label>間隔:</label>
        <select id="interval-select"></select>
        <input id="interval-custom" type="number" style="display:none">
    </div>
    <div class="setting-group">
        <label>天數:</label>
        <select id="days-select"></select>
        <input id="days-custom" type="number" style="display:none">
    </div>
    <div class="setting-group">
        <label>欄位:</label>
        <select id="cols-select"></select>
        <input id="cols-custom" type="number" style="display:none">
    </div>
    <button class="btn btn-blue" onclick="refreshTable()">更新表格</button>

    <input type="hidden" id="interval" value="60">
    <input type="hidden" id="days-count" value="7">
    <input type="hidden" id="cols-per-day" value="2">
</div>

<div id="main-container">
    <div id="sidebar">
        <div id="task-pool"></div>
    </div>
    <div id="calendar-area">
        <div id="calendar-grid"></div>
    </div>
</div>

<script>
MobileDragDrop.polyfill({dragImageTranslateOverride:MobileDragDrop.scrollBehaviourDragImageTranslateOverride});
window.addEventListener('touchmove',()=>{}, {passive:false});

let draggedItem=null;
let sourceContainerId=null;
let currentProjectName="預設專案";
let activeSchedule={};

document.getElementById('start-date').valueAsDate=new Date();

function populateTimeSelects(){
    const s=document.getElementById('start-time');
    const e=document.getElementById('end-time');
    if(s.options.length===0){
        for(let i=0;i<=24;i++){
            s.add(new Option(i,i));
            e.add(new Option(i,i));
        }
        s.value=6;e.value=22;
    }
    s.onchange=e.onchange=refreshTable;
}

function fitScheduleToView(){
    const grid=document.getElementById('calendar-grid');
    const area=document.getElementById('calendar-area');
    grid.style.transform='none';
    const scale=Math.min(1,area.clientWidth/grid.scrollWidth);
    grid.style.transform=`scale(${scale})`;
    grid.style.height=(grid.scrollHeight*scale)+'px';
}

function refreshTable(){generateGrid();}

function generateGrid(){
    const grid=document.getElementById('calendar-grid');
    grid.innerHTML='';
    const startH=parseInt(start-time?.value||6);
}

populateTimeSelects();
</script>
</body>
</html>
